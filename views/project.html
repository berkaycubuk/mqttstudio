{{define "main"}}

<header class="dashboard-header">
	<div class="dashboard-header-title">{{.Project.Name}}</div>

	<div class="dashboard-header-connection">
		<div id="project-connection-status"></div>

		<div class="dashboard-header-connection-actions">
			<form method="POST" action="/projects/{{.Project.Slug}}/connect">
				<button>Connect</button>
			</form>

			<form method="POST" action="/projects/{{.Project.Slug}}/disconnect">
				<button>Disconnect</button>
			</form>
		</div>
	</div>
</header>

<main class="dashboard-main">

<!-- SECTIONS -->
<div class="project-sections">

	{{$slug := .Project.Slug}}
	{{range .Sections}}
	<!-- SECTION -->
	<div class="project-section">
		<h2 class="project-section-title">{{.Name}}</h2>

		<!-- WIDGETS -->
		<div class="project-widgets">

			{{range .Widgets}}
			<!-- WIDGET -->
			<div class="project-widget" data-widget-id="{{.ID}}">
				<div>{{.Widget}}</div>
				{{if eq .Widget "TEXT"}}
				<div data-widget-value>-- NO DATA --</div>
				{{else if eq .Widget "BUTTON"}}
				<form method="POST" action="/projects/{{$slug}}/submit-value">
					<input style="display: none;" type="hidden" value="{{.ID}}" name="id" />
					<button class="button button--primary">Submit</button>
				</form>
				{{end}}
			</div>
			<!-- WIDGET -->
			{{end}}

			<!-- NEW WIDGET -->
			<div class="new-widget">
				<div class="project-widget">
					<div>Add new widget</div>
				</div>

				<!-- NEW WIDGET DIALOG -->
				<dialog class="new-widget-dialog">
					<header class="new-widget-dialog-header">
						<div class="new-widget-dialog-header-title">New widget</div>
						<button class="button button--secondary close-new-widget-dialog">Close</button>
					</header>
					<form method="POST" action="/projects/{{$slug}}/new-widget">
						<input style="display: none;" type="hidden" name="id" value="{{.ID}}" />
						<select class="input" name="widget">
							<option value="TEXT">TEXT</option>
							<option value="BUTTON">BUTTON</option>
						</select>
						<input class="input" type="text" name="topic" placeholder="Topic" />
						<input class="input" type="text" name="message" placeholder="Message" />
						<button class="button button--primary">Add</button>
					</form>
				</dialog>
				<!-- NEW WIDGET DIALOG -->
			</div>
			<!-- NEW WIDGET -->

		</div>
		<!-- WIDGETS -->
	</div>
	<!-- SECTION -->
	{{end}}

	<!-- NEW SECTION FORM -->
	<form method="POST" action="/projects/{{$slug}}/new-section">
		<div>New section</div>
		<input type="hidden" name="id" value="{{.Project.ID}}" />
		<input type="text" name="name" placeholder="Name" />
		<button>Add</button>
	</form>
	<!-- NEW SECTION FORM -->

</div>
<!-- SECTIONS -->

</main>
{{end}}

{{define "scripts"}}
<script>
	let newWidgetButtons = document.querySelectorAll(".new-widget");

	for (let i = 0; i < newWidgetButtons.length; i++) {
		let dialog = newWidgetButtons[i].querySelector("dialog");
		if (dialog == undefined) {
			continue;
		}

		let closeButton = dialog.querySelector(".close-new-widget-dialog");
		closeButton.addEventListener('click', () => {
			dialog.close();
		})

		newWidgetButtons[i].querySelector(".project-widget").addEventListener('click', () => {
			dialog.showModal();
		})
	}

	function fetchStatus() {
		let connectionStatus = document.getElementById("project-connection-status");

		fetch('/projects/{{.Project.Slug}}/connection').then(res => res.text()).then(data => {
			connectionStatus.innerHTML = data;
			setTimeout(fetchStatus, 2000)
		})
	}

	function fetchData() {
		fetch('/projects/{{.Project.Slug}}/data').then(res => res.json()).then(data => {
			if (data == null || data == undefined) return;

			for (let i = 0; i < data.length; i++) {
				let widget = document.querySelector('[data-widget-id="' + data[i].ID + '"]');
				if (!widget) continue;
				let value = widget.querySelector('[data-widget-value]');
				if (!value) continue;
				if (data[i].Data == undefined || data[i].Data == null) {
					value.innerHTML = "-- NO DATA --";
				} else {
					value.innerHTML = data[i].Data;
				}
			}

			setTimeout(fetchData, 2000)
		})
	}

	fetchStatus()
	fetchData()

</script>
{{end}}
